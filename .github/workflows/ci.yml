name: CI
# triggers on push to any branch
on:
  pull_request:
jobs:
  # TODO modify frontend build steps
  build-test-frontend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.11.1" # latest LTS at the time this is written.
      - name: build & lint
        working-directory: "./frontend"
        run: |
          npm ci
          npm run lint
          npm run build --if-present
      # Upload the built folder as an artifact
      - name: Upload build artifact
        uses: actions/upload-artifact@v2
        with:
          name: react-build
          path: frontend/build
      - name: test
        working-directory: "./frontend"
        run: |
          npm test

  # TODO modify backend build steps

  build-test-backend:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: devroot
          MONGO_INITDB_ROOT_PASSWORD: devroot

    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.11.1" # latest LTS at the time this is written.
      - name: build & lint
        working-directory: "./backend"
        run: |
          npm ci
          npm run lint
          npm run build --if-present
      - name: test
        working-directory: "./backend"
        run: |
          npm test
      - name: Enable backend service and test
        working-directory: "./backend"
        run: |
          npm run start&
          npm install -g wait-on
          npx wait-on http://localhost:3000/api/api-docs --timeout 100000
          npm run test:e2e
  # Playwright end-to-end test
  chrome-e2e-test:
    needs: [build-test-backend, build-test-frontend]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.11.1" # latest LTS at the time this is written.
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium
      - name: Set up environment variables into .env
        working-directory: "./e2eTests"
        run: |
          echo "REACT_APP_URL=http://localhost:5000" > .env
          echo "BACKEND_API_URL=http://localhost:3000/api" >> .env
      - name: Run Playwright E2E tests
        working-directory: "./e2eTests"
        run: npm ci
      # Run the start.sh script to spin up servers
      # Note that we are assuming the start.sh script spins up everything within 120s
      - name: Start servers
        working-directory: "./scripts"
        run: |
          chmod +x start-ci.sh
          ./start-ci.sh &
          npm install -g wait-on
          npx wait-on http://localhost:5000/ --timeout 100000
          npx wait-on http://localhost:3000/api/api-docs --timeout 1000009
      - name: Run Playwright E2E tests
        working-directory: "./e2eTests"
        run: npm run test:e2e
